[Outline](README.md) | Previous: [Hammer](C10.md) | Next: [Intro Timeline](C12.md)

# 11) Character Animations 

TODO intro

## 11.1) Character Animation Parameters

[YouTube]() | [Source before](https://github.com/hardlydifficult/2DUnityTutorial/archive/10_4_Flash.zip) | [Source after]()

Create parameters to use in the character's Animator Controller and a script to feed the data.

<details><summary>How</summary>

**Create animation parameters**:

 - Open menu Window -> Animator.
   - Select the Character's child sprite GameObject.
   - Switch to the 'Parameters' tab on the left.
   - Click the '+' button and select 'Float'.

<img src="https://i.imgur.com/p6F4gHG.png" width=300px />

 - Name the parameter "Speed".
 - Repeat to create:
   - A bool named 'isTouchingFloor'.
   - A bool named 'isClimbing'.
   - A bool named 'hasWeapon'.
 - Select the 'CharacterWalk' state (the orange box).
   - In the Inspector:
     - Speed: .4
     - Check the box near 'Multiplier' to enable a 'Parameter'.
       - Confirm Speed is selected (should be the default).

<img src="https://i.imgur.com/9A6mp98.png" width=300px />

<br>**Create PlayerAnimatorController**:

 - Create script Code/Animations/**PlayerAnimatorController**:

```csharp
using UnityEngine;

[RequireComponent(typeof(Rigidbody2D))]
[RequireComponent(typeof(LadderMovement))]
[RequireComponent(typeof(WeaponHolder))]
public class CharacterAnimatorController : MonoBehaviour
{
  Animator animator;

  Rigidbody2D myBody;

  LadderMovement ladderMovement;

  FloorDetector floorDetector;

  WeaponHolder weaponHolder;

  protected void Awake()
  {
    animator = GetComponentInChildren<Animator>();
    myBody = GetComponent<Rigidbody2D>();
    ladderMovement = GetComponent<LadderMovement>();
    floorDetector = GetComponentInChildren<FloorDetector>();
    weaponHolder = GetComponent<WeaponHolder>();
  }

  protected void LateUpdate() 
  {
    animator.SetFloat("Speed", myBody.velocity.magnitude);
    animator.SetBool("isTouchingFloor", 
      floorDetector.isTouchingFloor);
    animator.SetBool("isClimbing", ladderMovement.isOnLadder);
    animator.SetBool("hasWeapon", 
      weaponHolder.currentWeapon != null);
  }
}
```

<br>**Configure Character**:

 - Add **PlayerAnimatorController** to the Character.

<br>**Test**:

 - The Character should stop its animation when you are not moving and resume walking when moving left and right.  He will also appear to be walking while jumping and climbing, that will be fixed soon.

<hr></details><br>
<details><summary>Explain the code</summary>

using clauses at the top of a file brings APIs into scope. Used for:

 - UnityEngine.Animator
 - UnityEngine.MonoBehaviour
 - UnityEngine.RequireComponentAttribute
 - UnityEngine.Rigidbody2D

```csharp
using UnityEngine;
```

This is a Unity-specific attribute which tells the Unity editor that these components must also be on this GameObject.

```csharp
[RequireComponent(typeof(Rigidbody2D))]
[RequireComponent(typeof(LadderMovement))]
[RequireComponent(typeof(WeaponHolder))]
```

We inherit from MonoBehaviour, which allows this script to be added as a component on a GameObject.

public is optional here. Used for consistency.

```csharp
public class CharacterAnimatorController : MonoBehaviour
{
```

These are various components on this GameObject.  Cached here for performance.

```csharp
  Animator animator;
  
  Rigidbody2D myBody;

  LadderMovement ladderMovement;

  FloorDetector floorDetector;

  WeaponHolder weaponHolder;
```

Awake is a Unity event which is called once, the first time the GameObject is added to a scene.

protected is optional here.  Used for consistency.

```csharp
  protected void Awake()
  {
```

Here we get a reference to various components on this GameObject.

For the animator and floorDetector, we also check the child GameObjects.  We do this because the sprite and animator are usually a child of the parent GameObject, and the FloorDetector may be on a child 'feet' GameObject.

```csharp
    animator = GetComponentInChildren<Animator>();
    myBody = GetComponent<Rigidbody2D>();
    ladderMovement = GetComponent<LadderMovement>();
    floorDetector = GetComponentInChildren<FloorDetector>();
    weaponHolder = GetComponent<WeaponHolder>();
  }
```

LateUpdate is a Unity method which is called once per frame, after all the Update calls have completed.

protected is optional here.  Used for consistency.

```csharp
  protected void LateUpdate() 
  {
```

Here we are setting the parameter values for each of the parameters created, by forwarding a value to the animator from the relevant component.

```csharp
    animator.SetFloat("Speed", myBody.velocity.magnitude);
    animator.SetBool("isTouchingFloor", 
      floorDetector.isTouchingFloor);
    animator.SetBool("isClimbing", ladderMovement.isOnLadder);
    animator.SetBool("hasWeapon", 
      weaponHolder.currentWeapon != null);
  }
}
```

</details>
<details><summary>When do you use Animator Controller parameters vs Play(state) to change animations?</summary>

It's up to you.  Both approaches have the same capabilities, but by using animation parameters you can let the Animator Controller own much of the logic - simplifying your code and debugging.

I prefer to use Play for simple objects like the Hammer, and use animation parameters for more complex ones like entities.

You can also use a combination of the two approaches.  Calling Play will change the current Animator State, and from there any transitions from that state will be considered.

<hr></details>
<details><summary>Why LateUpdate instead of Update or FixedUpdate?</summary>

TODO

<hr></details>
<details><summary>What unit/scale is speed defined in?</summary>

Percent.  1 represents the speed as it was defined in the animation itself.  Going to 2 would double the playback speed, going to .5 would cut the playback speed in half.

<hr></details>
<details><summary>How does the Multiplier Parameter work?</summary>

Various settings for the animator state may be modified with one of the parameters we define in the Animator Controller.  Here we are using speed with a default value of .4.  When the animation is playing, the animation playback speed is multiplied by the Speed parameter (which is the velocity magnitude) - so if we are not moving the animation actually pauses, and it slows down / speeds up with our movement.

<hr></details>

## 11.2) Jump animation

[YouTube]() | [Source before]() | [Source after]()

Add an animation to the character for jumping. 

<details open><summary>How</summary>

Jump animation:

 - Select the character's sprite and in the Animation window, create a new clip Animations/**CharacterJump**:
   - Select the sprites for the jump animation. We are using **adverturer_spritesheet_7** and **8**.
   - Drag and drop the sprites onto the Animation timeline.

<img src="https://i.imgur.com/0rHCGDm.gif" width=300px />

 - In the Animator window:
   - Select the CharacterJump state:
     - Speed: .05
     - Check to use the Speed Multiplier Parameter: 'Speed'

<br>Transition to jump:

   - Right click on the 'Any State' box and select 'Make Transition'.
     - An arrow will follow your mouse, click on the CharacterJump state to create the transition.

<img src="https://i.imgur.com/Fl0WTPO.gif" width=300px />

 - Select the transition arrow just created, in the Inspector click the plus to create a new condition.

<img src="https://i.imgur.com/WgOfzQY.png" width=150px />

 - Change the condition to read 'isTouchingFloor false'.
 - Under 'Settings':
   - Transition Duration: 0
   - Uncheck 'Can Transition to Self'
 - Create a transition from CharacterJump to CharacterWalk.
 - Select the transition just created:
   - Add a condition: isTouchingFloor true
   - Uncheck 'Has Exit Time'
   - Transition Duration: 0

<hr></details><br>
<details><summary>Why transition from Any State instead of from CharacterWalk?</summary>

Any State is a special 'state' in the Animator Controller, allowing you to define transitions which could happen at any time.

You could create this transition from the CharacterWalk state instead.  However I am using Any State because as we add more animations for the character, we won't need to define as many total transitions.

<hr></details>
<details><summary>How do animation conditions work?</summary>

For transitions with one or more conditions, we change states when all conditions are met.  This could be a single parameter such as the bool we are using here, or it could be a combination of factors.

<hr></details>
<details><summary>What does the Transition Duration impact?</summary>

Once the conditions are met, the transition from one state to the other completes in the 'Transition Duration' time.  This is a great feature for 3D models as the Unity animator will smooth the transition from one stance to another.  However for sprites, there is no smoothing so we typically want a transition duration of 0.

<hr></details>
<details><summary>What does the Can Transition to Self impact?</summary>

When creating a transition from Any State, an option for Can Transition to Self is available.  

 - Checked (the default): This transition applies even when in the target state.  In this example, since the condition is just a bool check and there is no Exit Time - transition to self would cause the animation to keep starting over.
 - Unchecked: This transition effectively does not exist while in the target state.  e.g., I can't jump restart jumping while jumping.

<hr></details>
<details><summary>What does Exit Time do and how does it relate to conditions?</summary>

Has Exit Time is an additional way of triggering a transition.  So if a transition has both Has Exit Time and Conditions defined, the transition occurs when **either** the time has passed **or** the conditions are true.

<hr></details>


## 11.3) Additional character animations

[YouTube]() | [Source before]() | [Source after]()

Add an animation for when climbing ladders and while idle.

<details><summary>How</summary>

**Climb animation**:

 - Create a new animation for the character Animations/**CharacterClimb**.anim
   - Drag in the sprites for the climb animation.  We are using **adverturer_spritesheet_5** and **6**.
 - Open the character's Animator Controller:
   - Select the CharacterClimb state and use the Speed parameter times .1
   - Create a transition from Any State to CharacterClimb.
     - Condition: isClimbing true
   - Create a transition from CharacterClimb to CharacterWalk.
     - Uncheck Has Exit Time
     - Transition Duration: 0
     - Uncheck Can Transition to Self
     - Condition: isClimbing false
   - Select the transition from Any State to CharacterJump
     - Condition: isClimbing false

<br>**Idle animation**:

 - Create a new animation for the character Animations/**CharacterIdle**.anim
   - Click record
     - Change the 'Sprite' under the character's Sprite Renderer component to an idle stance. We are using **adventurer_tilesheet_0**.
     - Double click to create a keyframe at 1:00.
     - Switch the current time position to 0:30.
       - This will move the white line, indicating where in the timeline modifications will be made. 
     - Set the Transform scale to (1, .95, 1).
     - Switch the time to 1:00 and set the Transform scale to (1, 1, 1).
     - Then stop recording.   
 - Open the character's Animator Controller:
   - In the Animator, create a transition from CharacterWalk to CharacterIdle:
     - Uncheck Has Exit Time
     - Transition Duration: 0
     - Condition: 'Speed' is 'Less' than '.1'
   - Make a transition from CharacterIdle to CharacterWalk:
     - Uncheck Has Exit Time
     - Transition Duration: 0
     - Condition: 'Speed' is 'Greater' than '.1'

<br>**Breakdance animation**:

 - Create a new animation for the character Animations/**CharacterDance**.anim
   - Select all the sprites for this animation and drag them into the timeline. We are using **adventurer_tilesheet_11** **- 21** (10 sprites).
 - Open the character's Animator Controller:
   - Change the CharacterDance speed to '.1'
   - Create a transition from CharacterIdle to CharacterDance.
     - Exit Time: 3
     - Transition Duration: 0
   - Create a transition from CharacterDance to CharacterIdle.
     - Transition Duration: 0
   - Create a transition from CharacterDance to CharacterWalk.
     - Uncheck 'Has Exit Time'
     - Transition Duration: 0
     - Condition: 'Speed' is 'Greater' than '.1'

<hr></details>
                         
## To Review

<details><summary>Testing / debugging tips</summary>

 - TODO

</details>

## Up Next

[**Chapter 12** Intro Timeline](C12.md)

<br><hr>

Questions, issues, or suggestions?  Please use the YouTube comments for the best fit section.

Support on [Patreon](https://www.patreon.com/HardlyDifficult), with [Paypal](https://u.muxy.io/tip/HardlyDifficult), or by subscribing on [Twitch](https://www.twitch.tv/HardlyDifficult/subscribe) (free with Amazon Prime).

[License](TODO). Created live at [twitch.tv/HardlyDifficult](https://www.twitch.tv/HardlyDifficult) August 2017.